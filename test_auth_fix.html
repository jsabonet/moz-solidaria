<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Auth Fix</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .result { margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 3px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Teste de Corre√ß√µes de Autentica√ß√£o</h1>
        
        <div class="test-section">
            <h3>1. Teste de Login</h3>
            <button onclick="testLogin()">Testar Login</button>
            <div id="loginResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. Verificar Token Storage</h3>
            <button onclick="checkTokenStorage()">Verificar localStorage</button>
            <div id="tokenResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Teste de Registro</h3>
            <button onclick="testRegister()">Testar Endpoint Registro</button>
            <div id="registerResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Simular Cache Cleanup</h3>
            <button onclick="testCacheCleanup()">Testar Cache Cleanup</button>
            <div id="cacheResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://mozsolidaria.org/api/v1';

        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = 'Testando login...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/token/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'adamoabdala',
                        password: 'Jeison2@@'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Salvar no localStorage como 'authToken'
                    localStorage.setItem('authToken', data.access);
                    localStorage.setItem('refreshToken', data.refresh);
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            ‚úÖ Login bem-sucedido!<br>
                            Token salvo como 'authToken': ${data.access.substring(0, 50)}...<br>
                            Refresh token salvo
                        </div>
                    `;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ùå Erro no login: ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        function checkTokenStorage() {
            const resultDiv = document.getElementById('tokenResult');
            
            const authToken = localStorage.getItem('authToken');
            const token = localStorage.getItem('token');
            const refreshToken = localStorage.getItem('refreshToken');
            const userData = localStorage.getItem('userData');
            
            resultDiv.innerHTML = `
                <strong>Estado do localStorage:</strong><br>
                - authToken: ${authToken ? '‚úÖ Presente (' + authToken.substring(0, 30) + '...)' : '‚ùå Ausente'}<br>
                - token (antigo): ${token ? '‚ö†Ô∏è Presente (deveria estar removido)' : '‚úÖ Ausente'}<br>
                - refreshToken: ${refreshToken ? '‚úÖ Presente' : '‚ùå Ausente'}<br>
                - userData: ${userData ? '‚úÖ Presente' : '‚ùå Ausente'}
            `;
        }

        async function testRegister() {
            const resultDiv = document.getElementById('registerResult');
            resultDiv.innerHTML = 'Testando endpoint de registro...';
            
            try {
                const response = await fetch(`${API_BASE}/client-area/auth/register/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        username: 'test_user_' + Date.now(),
                        email: 'test@example.com',
                        password: 'TestPassword123!',
                        userType: 'donor'
                    })
                });

                if (response.status === 200 || response.status === 201) {
                    resultDiv.innerHTML = `<div class="success">‚úÖ Endpoint de registro est√° funcionando (${response.status})</div>`;
                } else if (response.status === 404) {
                    resultDiv.innerHTML = `<div class="error">‚ùå Endpoint n√£o encontrado (404) - URL ainda incorreta</div>`;
                } else {
                    const error = await response.text();
                    resultDiv.innerHTML = `<div class="error">‚ö†Ô∏è Endpoint encontrado mas erro: ${response.status} - ${error}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Erro de rede: ${error.message}</div>`;
            }
        }

        function testCacheCleanup() {
            const resultDiv = document.getElementById('cacheResult');
            
            // Primeiro, salvar um token
            localStorage.setItem('authToken', 'test_token_123');
            localStorage.setItem('token', 'old_token_456');
            
            resultDiv.innerHTML = 'Tokens salvos. Simulando cache cleanup...<br>';
            
            // Simular a fun√ß√£o de cache cleanup (vers√£o CORRIGIDA)
            function cleanupCacheFixed() {
                // Vers√£o corrigida: s√≥ remove 'token', n√£o 'authToken'
                localStorage.removeItem('token');
                // Manter authToken intacto
                console.log('Cache cleanup CORRIGIDO: removeu apenas token antigo');
            }
            
            // Simular fun√ß√£o problem√°tica (vers√£o ANTERIOR)
            function cleanupCacheBroken() {
                // Vers√£o problem√°tica: remove 'authToken' por engano
                localStorage.removeItem('authToken');
                console.log('Cache cleanup PROBLEM√ÅTICO: removeu authToken por engano');
            }
            
            setTimeout(() => {
                cleanupCacheFixed();
                
                const authTokenAfter = localStorage.getItem('authToken');
                const tokenAfter = localStorage.getItem('token');
                
                resultDiv.innerHTML += `
                    <strong>Resultado ap√≥s cache cleanup CORRIGIDO:</strong><br>
                    - authToken: ${authTokenAfter ? '‚úÖ Mantido' : '‚ùå Removido incorretamente'}<br>
                    - token (antigo): ${tokenAfter ? '‚ùå N√£o foi removido' : '‚úÖ Removido corretamente'}
                `;
            }, 1000);
        }

        // Executar verifica√ß√£o inicial
        window.onload = function() {
            checkTokenStorage();
        };
    </script>
</body>
</html>
